{%- assign text_direction = 'localization.text_direction_trigger' | t | downcase -%}
<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}" {%- if text_direction == 'rtl' %} dir="rtl"{% endif -%} data-shop-currency="{{ shop.currency }}">
  <head>
    {%- render 'ecom_header' -%}
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="">
    <meta name="google-site-verification" content="RM8cCNg1zcq2rOEzroFlzSVv1kihc3ZcQOV3yzcf5JE" />
    <link rel="canonical" href="{{ canonical_url }}">
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-M6XM24PT');</script>
    <!-- End Google Tag Manager -->

    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    {%- unless settings.type_header_font.system? and settings.type_body_font.system? -%}
      <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    {%- endunless -%}

    <meta name="msvalidate.01" content="82B3573226AE640542FE42D0556355B6" />

    <title>
      {{ page_title }}
      {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
      {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
      {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
    </title>

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    {% render 'meta-tags' %}
    <meta name="google-site-verification" content="Cqi_Sa43Cdge2vGwQSa7GJZv7Jb6NYDqht_ST5B9ID4" />

    <script src="{{ 'vendor-v4.js' | asset_url | split: '?' | first }}" defer="defer"></script>
    <script src="{{ 'pubsub.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'global.js' | asset_url }}" defer="defer"></script>
    <script crossorigin="anonymous" src="{{ 'modules-basis.js' | asset_url }}" defer="defer"></script>

    {{ content_for_header }}

    {%- liquid
      render 'css-variables'
      echo 'base.css' | asset_url | stylesheet_tag: preload: true
      if text_direction == 'rtl'
        echo 'rtl.css' | asset_url | stylesheet_tag
      endif
    -%}

    <link rel="stylesheet" href="{{ 'apps.css' | asset_url }}" media="print" fetchpriority="low" onload="this.media='all'">

    {%- unless settings.type_body_font.system? -%}
      <link rel="preload" as="font" href="{{ settings.type_body_font | font_url }}" type="font/woff2" crossorigin>
    {%- endunless -%}
    {%- unless settings.type_header_font.system? -%}
      <link rel="preload" as="font" href="{{ settings.type_header_font | font_url }}" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- if settings.predictive_search_enabled -%}
      <link rel="stylesheet" href="{{ 'component-predictive-search.css' | asset_url }}" media="print" onload="this.media='all'">
    {%- endif -%}
    {%- if settings.quick_view_enabled -%}
      <link rel="stylesheet" href="{{ 'component-quick-view.css' | asset_url }}" media="print" onload="this.media='all'">
    {%- endif -%}
    {%- if settings.color_swatches_enabled -%}
      <link rel="stylesheet" href="{{ 'component-color-swatches.css' | asset_url }}" media="print" onload="this.media='all'">
    {%- endif -%}
    {%- if linklists.gift-wrapping.links != blank and linklists.gift-wrapping.links.first.type == 'product_link' -%}
      <link rel="stylesheet" href="{{ 'component-gift-wrapping.css' | asset_url }}" media="print" onload="this.media='all'">
      <noscript>{{ 'component-gift-wrapping.css' | asset_url | stylesheet_tag }}</noscript>
    {%- endif -%}

    {%- render 'js-variables' -%}

    <!-- Google tag (gtag.js) - If GA4 is also configured in GTM, you can remove this -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0VQ9YSC07S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} // eslint-disable-line
      gtag('js', new Date());
      gtag('config', 'G-0VQ9YSC07S');
    </script>

    <!-- Meta Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s){
        if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0; t.src=v;
        s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s);
      }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '3414485338688940');
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=3414485338688940&ev=PageView&noscript=1"/></noscript>
    <!-- End Meta Pixel Code -->

    <!-- Microsoft Clarity -->
    <script>
      (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "r5n66fd3zq");
    </script>
    <!-- End Clarity -->

    <style>
      @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }
      @-webkit-keyframes salePulse { from { background-color: #a85a3b; } 50% { background-color: #800020; -webkit-transform: scale(1.1); } to { background-color: #a85a3b; } }
      @keyframes salePulse { from { background-color: #a85a3b; } 50% { background-color: #800020; transform: scale(1.1); } to { background-color: #a85a3b; } }

      ul.list-menu.list-menu--inline > li:nth-last-child(2) {
        background: #a85a3b;
        display: block;
        width: 50px;
        text-align: center;
        border-radius: 3em;
        color: #fff;
        font-weight: bold;
        -webkit-animation-name: salePulse;
        -webkit-animation-duration: 1s;
        -webkit-animation-iteration-count: infinite;
        margin: 0 auto;
        animation: bounce 300ms alternate infinite cubic-bezier(.2, .65, .6, 1);
      }
      ul.list-menu.list-menu--inline > li:nth-last-child(2):hover { animation-play-state: paused; }
      ul.list-menu.list-menu--inline > li:nth-last-child(2) a { color:#fff !important; }
    </style>
  </head>

  <body class="template-{{ request.page_type }}{% if request.design_mode %} shopify-design-mode{% endif %}"
    {%- if settings.image_zoom_effect_enabled %} data-animate-image{% endif -%}
    {%- if settings.image_loading_bar_enabled %} data-lazy-image{% endif -%}
    {%- if settings.heading_capitalize %} data-heading-capitalize{% endif -%}
    {%- if settings.heading_center %} data-heading-center{% endif -%}
    {%- if settings.price_superscript %} data-price-superscript{% endif -%}
    {%- if settings.button_corner_radius > 0 %} data-button-round{% endif -%}
  >
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M6XM24PT" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <a class="skip-to-content-link button button--small visually-hidden" href="#MainContent">
      {{ 'accessibility.skip_to_text' | t }}
    </a>

    {% render 'transition-cover' %}

    <div class="transition-body">
      {% sections 'header-group' %}
      <div class="transition-content">
        <main id="MainContent" class="content-for-layout focus-none shopify-section" role="main" tabindex="-1">
          {{ content_for_layout }}
        </main>
        {% sections 'footer-group' %}
      </div>
    </div>

    {% sections 'overlay-group' %}

    <ul hidden>
      <li id="a11y-refresh-page-message">{{ 'accessibility.refresh_page' | t }}</li>
    </ul>

    <svg xmlns="http://www.w3.org/2000/svg" class="hidden">
      <symbol id="icon-cart" fill="none" viewBox="0 0 18 19">
        <path d="M3.09333 5.87954L16.2853 5.87945V5.87945C16.3948 5.8795 16.4836 5.96831 16.4836 6.07785V11.4909C16.4836 11.974 16.1363 12.389 15.6603 12.4714C11.3279 13.2209 9.49656 13.2033 5.25251 13.9258C4.68216 14.0229 4.14294 13.6285 4.0774 13.0537C3.77443 10.3963 2.99795 3.58502 2.88887 2.62142C2.75288 1.42015 0.905376 1.51528 0.283581 1.51478" stroke="currentColor"/>
        <path d="M13.3143 16.8554C13.3143 17.6005 13.9183 18.2045 14.6634 18.2045C15.4085 18.2045 16.0125 17.6005 16.0125 16.8554C16.0125 16.1104 15.4085 15.5063 14.6634 15.5063C13.9183 15.5063 13.3143 16.1104 13.3143 16.8554Z" fill="currentColor"/>
        <path d="M3.72831 16.8554C3.72831 17.6005 4.33233 18.2045 5.07741 18.2045C5.8225 18.2045 6.42651 17.6005 6.42651 16.8554C6.42651 16.1104 5.8225 15.5063 5.07741 15.5063C4.33233 15.5063 3.72831 16.1104 3.72831 16.8554Z" fill="currentColor"/>
      </symbol>
    </svg>

    {%- if settings.image_loading_bar_enabled %}
      <script src="{{ 'lazyimage.js' | asset_url }}" async></script>
    {% endif -%}
    {%- if settings.predictive_search_enabled -%}
      <script src="{{ 'predictive-search.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}
    {%- if settings.quick_view_enabled -%}
      <script src="{{ 'quick-view.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}
    {%- if settings.color_swatches_enabled -%}
      <script src="{{ 'color-swatches.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}
    {%- if linklists.gift-wrapping.links != blank and linklists.gift-wrapping.links.first.type == 'product_link' -%}
      <script src="{{ 'gift-wrapping.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    {%- render 'ecom_footer' -%}

    <!-- Metricool Tracking (fixed domain & single include) -->
    <script>
      (function loadMetricool(cb){
        var h=document.getElementsByTagName('head')[0], s=document.createElement('script');
        s.type='text/javascript'; s.async=true; s.src='https://tracker.metricool.com/resources/be.js';
        s.onload=cb; s.onreadystatechange=cb; h.appendChild(s);
      })(function(){ try{ beTracker.t({hash:'8711f68830983b188c2b19dbf359784a'}); }catch(e){} });
    </script>

    <!-- Wishlist logic (unified & fixed) -->
    <script>
      (function(){
        if (window.__WISHLIST_ENHANCED__) return; // guard against double-run
        window.__WISHLIST_ENHANCED__ = true;

        // LocalStorage keys
        const LS_WISHLIST = 'wishlist';              // [id, ...]
        const LS_HANDLES  = 'wishlist_handles';      // [[id, handle], ...]
        const LS_CACHE    = 'wishlist_cache';        // [[id, productObj], ...]

        // Utils
        const readJSON  = (k, fb) => { try { return JSON.parse(localStorage.getItem(k) ?? fb); } catch { return JSON.parse(fb); } };
        const writeJSON = (k, v) => localStorage.setItem(k, JSON.stringify(v));
        const currency  = document.documentElement.getAttribute('data-shop-currency') || (window.Shopify && Shopify.currency && Shopify.currency.active) || 'USD';
        const formatMoney = (cents) => {
          const n = Number(cents || 0)/100;
          return n.toFixed(2) + ' ' + currency;
        };

        // State helpers
        const getList = () => readJSON(LS_WISHLIST, '[]').map(String);
        const setList = (arr) => { const uniq = Array.from(new Set(arr.map(String))); writeJSON(LS_WISHLIST, uniq); return uniq; };
        const getHandles = () => new Map(readJSON(LS_HANDLES, '[]'));
        const setHandles = (m) => writeJSON(LS_HANDLES, [...m.entries()]);
        const getCache   = () => new Map(readJSON(LS_CACHE,   '[]'));
        const setCache   = (m) => writeJSON(LS_CACHE,   [...m.entries()]);

        // UI helpers
        const formatBadge = (n) => (n > 9 ? '9+' : String(n));
        function updateHeaderWishlistCount(){
          const count = new Set(getList()).size;
          document.querySelectorAll('.wishlist-count').forEach((el) => {
            el.textContent = formatBadge(count);
            el.style.display = count > 0 ? 'flex' : 'none';
            const label = `Wishlist (${count})`;
            el.setAttribute('title', label);
            const parent = el.closest('a,button');
            if (parent) parent.setAttribute('aria-label', label);
          });
        }
        window.updateWishlistCount = updateHeaderWishlistCount; // optional expose

        // Core toggle
        async function toggleWishlist(id, handle, btn){
          id = String(id || '');
          if (!id) return;
          let list    = getList();
          const maps  = getHandles();
          const cache = getCache();

          const exists = list.includes(id);
          if (exists){
            list = list.filter((x) => x !== id);
            maps.delete(id);
            cache.delete(id);
            if (btn){ btn.classList.remove('in-wishlist','active'); btn.setAttribute('title','Add to Wishlist'); }
          } else {
            list.push(id);
            if (handle) maps.set(id, String(handle));
            if (btn){ btn.classList.add('in-wishlist','active'); btn.setAttribute('title','Remove from Wishlist'); }
            if (handle){
              try{
                const r = await fetch(`/products/${handle}.js`);
                if (r.ok){ const data = await r.json(); cache.set(id, data); }
              }catch(_e){}
            }
          }

          setHandles(maps); setCache(cache); setList(list); updateHeaderWishlistCount();
        }

        // Render wishlist page (if present)
        async function renderWishlistPage(){
          const grid = document.getElementById('wishlist-grid');
          if (!grid) return;

          const ids    = getList();
          const maps   = getHandles();
          const cache  = getCache();

          if (!ids.length){ grid.innerHTML = '<p>Your wishlist is empty.</p>'; return; }

          // Fetch any missing from cache (parallel)
          const fetches = ids
            .filter((id) => !cache.has(id) && maps.has(id))
            .map(async (id) => {
              const handle = maps.get(id);
              try{
                const r = await fetch(`/products/${handle}.js`);
                if (r.ok){ const data = await r.json(); cache.set(id, data); }
              }catch(_e){}
            });
          if (fetches.length) await Promise.all(fetches);
          setCache(cache);

          const products = ids.map((id) => cache.get(id)).filter(Boolean);
          grid.innerHTML = products.map((p) => {
            const img = (p.featured_image || (p.images && p.images[0]) || '').toString();
            const priceCents = Number(p.price_min ?? p.price ?? (p.variants && p.variants[0] && p.variants[0].price) ?? 0);
            return `
              <div class="wishlist-card">
                <a href="/products/${p.handle}">
                  <img src="${img}" alt="${p.title}" loading="lazy">
                </a>
                <h3><a href="/products/${p.handle}">${p.title}</a></h3>
                <p>${formatMoney(priceCents)}</p>
                <button class="card__badge--wishlist" data-product-id="${p.id}" data-product-handle="${p.handle}">Remove</button>
              </div>
            `;
          }).join('');
        }

        // Event bindings
        document.addEventListener('click', async (e) => {
          const btn = e.target.closest('.card__badge--wishlist');
          if (!btn) return;
          e.preventDefault();

          if (btn.dataset.loading === '1') return; // guard double-taps
          btn.dataset.loading = '1';
          await toggleWishlist(btn.dataset.productId, btn.dataset.productHandle, btn);
          btn.dataset.loading = '';

          // If wishlist page present, re-render after change
          renderWishlistPage();
        });

        document.addEventListener('DOMContentLoaded', () => {
          updateHeaderWishlistCount();
          const set = new Set(getList());
          document.querySelectorAll('.card__badge--wishlist').forEach((btn) => {
            const id = String(btn.dataset.productId || '');
            const inList = set.has(id);
            btn.classList.toggle('in-wishlist', inList);
            btn.classList.toggle('active', inList);
            btn.setAttribute('title', inList ? 'Remove from Wishlist' : 'Add to Wishlist');
          });
          renderWishlistPage();
        });

        window.addEventListener('storage', (e) => {
          if (e.key === LS_WISHLIST || e.key === LS_CACHE) {
            updateHeaderWishlistCount();
            renderWishlistPage();
          }
        });
      })();
    </script>
  </body>
</html>
