{%- liquid
  assign logo_position = section.settings.logo_position
  assign transparent_header = section.settings.transparent_header
  assign sticky_header = section.settings.sticky_header
  assign show_mega_menu = section.settings.show_mega_menu
  assign recommended_collection = section.settings.recommended_collection
-%}

<style>
  /* ============ HEADER STYLES ============ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 30px;
    background: {{ section.settings.header_bg_color }};
    position: relative;
    z-index: 1000;
    {% if sticky_header %}
      position: sticky;
      top: 0;
    {% endif %}
    {% if transparent_header %}
      background: transparent;
      position: absolute;
      width: 100%;
    {% endif %}
  }

  .header__left {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .header__logo img {
    max-height: {{ section.settings.logo_height_desktop }}px;
  }

  .header__nav {
    display: flex;
    gap: 20px;
  }

  .header__nav-item {
    position: relative;
  }

  .header__nav-link {
    color: {{ section.settings.nav_color }};
    font-size: 16px;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .header__nav-link:hover {
    color: {{ section.settings.nav_hover_color }};
  }

  .header__right {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .header__icon {
    position: relative;
    cursor: pointer;
    background: none;
    border: none;
    padding: 8px;
  }

  .cart-count-bubble {
    background-color: #ff6b6b;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: -8px;
    right: -8px;
  }

  /* Mega Menu */
  .mega-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: none;
    z-index: 999;
    padding: 20px;
  }

  .mega-menu.active {
    display: block;
  }

  .mega-menu__grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
  }

  .mega-menu__item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
  }

  /* Mobile Menu */
  .mobile-menu-toggle {
    display: none;
  }

  .mobile-menu {
    position: fixed;
    top: 0;
    left: -100%;
    width: 80%;
    max-width: 300px;
    height: 100vh;
    background: white;
    z-index: 1001;
    transition: left 0.3s ease;
    padding: 20px;
  }

  .mobile-menu.active {
    left: 0;
  }

  .mobile-menu__item img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
  }

  /* Search Modal */
  .search-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .search-modal.active {
    display: flex;
  }

  .search-modal__content {
    background: white;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
  }

  .search-modal__input {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #E5E5E5;
    border-radius: 8px;
  }

  /* Cart Drawer */
  .cart-drawer {
    position: fixed;
    top: 0;
    right: -100%;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 12px rgba(0,0,0,0.1);
    z-index: 1001;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .cart-drawer.active {
    right: 0;
  }

  .cart-drawer__header {
    padding: 20px;
    border-bottom: 1px solid #E5E5E5;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cart-drawer__content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .cart-drawer__empty {
    text-align: center;
    padding: 40px 20px;
    color: #666;
  }

  .cart-drawer__item {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    border-bottom: 1px solid #E5E5E5;
    padding-bottom: 20px;
  }

  .cart-drawer__item img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
  }

  .cart-drawer__recommended {
    padding: 20px;
    background: #F8F6F3;
    border-top: 1px solid #E5E5E5;
  }

  .cart-drawer__recommended-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }

  .cart-drawer__recommended-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
  }

  /* Wishlist & Compare Styles */
  .wishlist-count-bubble {
    background-color: #ff6b6b;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: -8px;
    right: -8px;
    animation: wishlistPulse 0.3s ease;
  }

  @keyframes wishlistPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .compare-count-bubble {
    background-color: #4CAF50;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: -8px;
    right: -8px;
    animation: comparePulse 0.3s ease;
  }

  @keyframes comparePulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .compare-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .compare-modal.active {
    opacity: 1;
    visibility: visible;
  }

  .compare-modal-content {
    background: white;
    border-radius: 12px;
    width: 100%;
    max-width: 1200px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: translateY(-20px) scale(0.95);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  .compare-modal.active .compare-modal-content {
    transform: translateY(0) scale(1);
  }

  .compare-modal-header {
    padding: 20px 30px;
    border-bottom: 2px solid #E5E5E5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .compare-modal-title {
    font-size: 20px;
    font-weight: 600;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .compare-modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: white;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .compare-modal-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
  }

  .compare-modal-body {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    padding: 0;
  }

  .compare-selection-section {
    background: #F8F6F3;
    padding: 20px;
    border-bottom: 1px solid #E5E5E5;
  }

  .compare-selection-title {
    font-size: 14px;
    font-weight: 600;
    color: #666;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .compare-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    background: white;
    border-radius: 8px;
  }

  .compare-product-card {
    background: white;
    border: 2px solid #E5E5E5;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
  }

  .compare-product-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .compare-product-card.selected {
    border-color: #4CAF50;
    background: #E8F5E9;
  }

  .compare-product-card.selected::after {
    content: '✓';
    position: absolute;
    top: 5px;
    right: 5px;
    background: #4CAF50;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }

  .compare-product-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 8px;
  }

  .compare-product-name {
    font-size: 11px;
    color: #333;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .compare-product-price {
    font-size: 12px;
    color: #667eea;
    font-weight: 600;
    margin-top: 5px;
  }

  .compare-table-section {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }

  .compare-empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .compare-empty-icon {
    width: 100px;
    height: 100px;
    margin: 0 auto 20px;
    opacity: 0.3;
  }

  .compare-table-container {
    display: grid;
    grid-template-columns: 150px 1fr 1fr;
    gap: 0;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .compare-table-header {
    display: contents;
  }

  .compare-header-label {
    background: #667eea;
    color: white;
    padding: 15px;
    font-weight: 600;
    font-size: 14px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .compare-header-product {
    background: #F8F6F3;
    padding: 20px;
    text-align: center;
    border-right: 1px solid #E5E5E5;
    position: relative;
  }

  .compare-header-product:last-child {
    border-right: none;
  }

  .compare-product-main-image {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .compare-product-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 10px;
    line-height: 1.3;
  }

  .compare-product-main-price {
    font-size: 20px;
    color: #667eea;
    font-weight: 700;
  }

  .compare-remove-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(231, 76, 60, 0.9);
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .compare-remove-btn:hover {
    background: #e74c3c;
    transform: scale(1.1);
  }

  .compare-table-row {
    display: contents;
  }

  .compare-row-label {
    background: #F8F6F3;
    padding: 15px;
    font-weight: 600;
    font-size: 13px;
    color: #666;
    border-top: 1px solid #E5E5E5;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .compare-row-value {
    padding: 15px;
    font-size: 14px;
    color: #333;
    border-top: 1px solid #E5E5E5;
    border-right: 1px solid #E5E5E5;
    text-align: center;
  }

  .compare-row-value:last-child {
    border-right: none;
  }

  .compare-row-value.highlight {
    background: #FFF3CD;
    font-weight: 600;
  }

  .compare-row-value.better {
    background: #D4EDDA;
    color: #155724;
    font-weight: 600;
  }

  .compare-actions {
    padding: 20px;
    background: #F8F6F3;
    border-top: 2px solid #E5E5E5;
    display: flex;
    gap: 15px;
    justify-content: center;
  }

  .compare-add-to-cart {
    padding: 12px 30px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
  }

  .compare-add-to-cart:hover {
    background: #764ba2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .compare-clear-btn {
    padding: 12px 30px;
    background: transparent;
    color: #e74c3c;
    border: 2px solid #e74c3c;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
  }

  .compare-clear-btn:hover {
    background: #e74c3c;
    color: white;
    transform: translateY(-2px);
  }

  .wishlist-heart {
    transition: all 0.3s ease;
  }

  .wishlist-heart.active {
    color: #ff6b6b;
    fill: #ff6b6b;
  }

  /* Responsive Styles */
  @media screen and (max-width: 768px) {
    .header__nav {
      display: none;
    }

    .mobile-menu-toggle {
      display: block;
    }

    .header__logo img {
      max-height: {{ section.settings.logo_height_mobile }}px;
    }

    .compare-modal-content {
      max-width: 100%;
      margin: 10px;
    }

    .compare-table-container {
      grid-template-columns: 100px 1fr 1fr;
    }

    .compare-product-main-image {
      width: 100px;
      height: 100px;
    }

    .compare-product-title {
      font-size: 14px;
    }

    .compare-row-label {
      font-size: 11px;
      padding: 10px 5px;
    }

    .compare-row-value {
      font-size: 12px;
      padding: 10px 5px;
    }

    .wishlist-count-bubble,
    .compare-count-bubble {
      width: 16px;
      height: 16px;
      font-size: 10px;
      top: -6px;
      right: -6px;
    }

    .cart-drawer {
      width: 100%;
      max-width: 300px;
    }
  }

  @media screen and (max-width: 480px) {
    .compare-table-container {
      display: block;
    }

    .compare-header-product {
      display: block;
      margin-bottom: 20px;
    }

    .compare-table-row {
      display: block;
      margin-bottom: 10px;
    }

    .compare-row-label {
      display: block;
      background: #667eea;
      color: white;
      margin-bottom: 5px;
    }

    .compare-row-value {
      display: block;
      border: none;
      padding: 10px;
      margin-bottom: 5px;
      background: #F8F6F3;
      border-radius: 4px;
    }
  }
</style>

<header class="header">
  <!-- LEFT: Mobile Menu Toggle + Logo -->
  <div class="header__left">
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
      <svg width="24" height="24">
        <use href="#icon-menu"></use>
      </svg>
    </button>
    <div class="header__logo">
      {% if section.settings.logo %}
        <img src="{{ section.settings.logo | img_url: 'master' }}" alt="{{ shop.name }}">
      {% else %}
        <h1>{{ shop.name }}</h1>
      {% endif %}
    </div>
  </div>

  <!-- CENTER: Navigation -->
  <nav class="header__nav">
    {% for link in section.settings.main_menu.links %}
      <div class="header__nav-item">
        <a href="{{ link.url }}" class="header__nav-link">{{ link.title }}</a>
        {% if link.links.size > 0 and show_mega_menu %}
          <div class="mega-menu">
            <div class="mega-menu__grid">
              {% for child_link in link.links %}
                <div class="mega-menu__item">
                  {% if child_link.object.featured_image %}
                    <img src="{{ child_link.object.featured_image | img_url: '200x' }}" alt="{{ child_link.title }}">
                  {% endif %}
                  <a href="{{ child_link.url }}">{{ child_link.title }}</a>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </nav>

  <!-- RIGHT: Search + Wishlist + Compare + Account + Cart Icons -->
  <div class="header__right">
    <button class="header__icon search-modal-toggle" onclick="openSearchModal()" title="{{ 'general.search.search' | t }}">
      <svg width="24" height="24">
        <use href="#icon-search"></use>
      </svg>
    </button>
    <button class="header__icon wishlist-icon" onclick="toggleWishlist()" title="Wishlist">
      <svg width="24" height="24" class="wishlist-heart">
        <use href="#icon-heart"></use>
      </svg>
      <span class="wishlist-count-bubble" id="wishlist-count" style="display: none;">0</span>
    </button>
    <button class="header__icon compare-icon" onclick="openCompareModal()" title="Compare Products">
      <svg width="24" height="24">
        <use href="#icon-compare"></use>
      </svg>
      <span class="compare-count-bubble" id="compare-count" style="display: none;">0</span>
    </button>
    {%- if shop.customer_accounts_enabled -%}
      <a href="{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}" class="header__icon" title="{%- if customer -%}{{ 'customer.account_fallback' | t }}{%- else -%}{{ 'customer.log_in' | t }}{%- endif -%}">
        <svg width="24" height="24">
          <use href="#icon-account"></use>
        </svg>
      </a>
    {%- endif -%}
    <button class="header__icon" id="cart-icon-bubble" onclick="openCartDrawer()" title="{{ 'templates.cart.cart' | t }}">
      <svg width="24" height="24">
        <use href="#icon-cart"></use>
      </svg>
      <span class="cart-count-bubble" style="display: {% if cart.item_count > 0 %}flex{% else %}none{% endif %}">
        {% if cart.item_count > 0 %}{{ cart.item_count }}{% endif %}
      </span>
    </button>
  </div>
</header>

<!-- Mobile Menu -->
<div class="mobile-menu" id="mobile-menu">
  <button onclick="toggleMobileMenu()">Close</button>
  <ul>
    {% for link in section.settings.main_menu.links %}
      <li class="mobile-menu__item">
        {% if link.links.size > 0 %}
          <button onclick="toggleMobileSubmenu(this)">{{ link.title }}</button>
          <ul style="display: none;">
            {% for child_link in link.links %}
              <li>
                {% if child_link.object.featured_image %}
                  <img src="{{ child_link.object.featured_image | img_url: '100x' }}" alt="{{ child_link.title }}">
                {% endif %}
                <a href="{{ child_link.url }}">{{ child_link.title }}</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <a href="{{ link.url }}">{{ link.title }}</a>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>

<!-- Search Modal -->
<div class="search-modal" id="search-modal">
  <div class="search-modal__content">
    <input type="text" class="search-modal__input" placeholder="{{ 'general.search.placeholder' | t }}">
    <button onclick="closeSearchModal()">Close</button>
  </div>
</div>

<!-- Cart Drawer -->
<div class="cart-drawer" id="cart-drawer">
  <div class="cart-drawer__header">
    <h2>Your Cart</h2>
    <button onclick="closeCartDrawer()">×</button>
  </div>
  <div class="cart-drawer__content" id="cart-content">
    {% if cart.item_count == 0 %}
      <div class="cart-drawer__empty">
        <p>Your cart is empty.</p>
      </div>
    {% else %}
      {% for item in cart.items %}
        <div class="cart-drawer__item">
          <img src="{{ item.image | img_url: '100x' }}" alt="{{ item.title }}">
          <div>
            <h3>{{ item.title }}</h3>
            <p>{{ item.price | money }}</p>
            <input type="number" value="{{ item.quantity }}" min="0" onchange="updateCartItem('{{ item.key }}', this.value)">
            <button onclick="updateCartItem('{{ item.key }}', 0)">Remove</button>
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
  <div class="cart-drawer__recommended" id="recommended-products">
    <h3>You May Also Like</h3>
    <div class="cart-drawer__recommended-grid"></div>
  </div>
</div>

<!-- Compare Modal -->
<div class="compare-modal" id="compare-modal">
  <div class="compare-modal-content">
    <div class="compare-modal-header">
      <h2 class="compare-modal-title">
        <svg width="24" height="24" fill="none" stroke="currentColor">
          <path d="M3 9h18M9 3v18" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Compare Products
      </h2>
      <button class="compare-modal-close" onclick="closeCompareModal()">×</button>
    </div>
    <div class="compare-modal-body">
      <div class="compare-selection-section">
        <h3 class="compare-selection-title">Select Products to Compare (Based on Your Cart Items)</h3>
        <div class="compare-products-grid" id="compare-products-grid"></div>
      </div>
      <div class="compare-table-section" id="compare-table-section">
        <div class="compare-empty-state" id="compare-empty-state">
          <svg class="compare-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="3" width="7" height="7" stroke-width="1.5"/>
            <rect x="14" y="3" width="7" height="7" stroke-width="1.5"/>
            <rect x="3" y="14" width="7" height="7" stroke-width="1.5"/>
            <rect x="14" y="14" width="7" height="7" stroke-width="1.5"/>
          </svg>
          <p>Select up to 2 products to compare</p>
        </div>
        <div class="compare-table-container" id="compare-table" style="display: none;"></div>
      </div>
    </div>
    <div class="compare-actions" id="compare-actions" style="display: none;">
      <button class="compare-add-to-cart" onclick="addComparedToCart()">Add Both to Cart</button>
      <button class="compare-clear-btn" onclick="clearComparison()">Clear Comparison</button>
    </div>
  </div>
</div>

<!-- SVG Icons -->
<svg style="display: none;">
  <symbol id="icon-menu" viewBox="0 0 24 24">
    <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2"/>
  </symbol>
  <symbol id="icon-search" viewBox="0 0 24 24">
    <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
    <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2"/>
  </symbol>
  <symbol id="icon-account" viewBox="0 0 24 24">
    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
    <path d="M5 21c0-4.418 3.582-8 8-8s8 3.582 8 8" stroke="currentColor" stroke-width="2"/>
  </symbol>
  <symbol id="icon-cart" viewBox="0 0 24 24">
    <path d="M3 3h2l3 9h11l3-9H6m0 0L4 8m14 6a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z" stroke="currentColor" stroke-width="2"/>
  </symbol>
  <symbol id="icon-compare" fill="none" viewBox="0 0 24 24">
    <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
    <line x1="12" y1="3" x2="12" y2="21" stroke="currentColor" stroke-width="2"/>
    <line x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2"/>
  </symbol>
  <symbol id="icon-heart" fill="none" viewBox="0 0 24 24">
    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2"/>
  </symbol>
</svg>

<script>
  // ============ HEADER FUNCTIONALITY ============
  function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobile-menu');
    mobileMenu.classList.toggle('active');
    document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
  }

  function toggleMobileSubmenu(button) {
    const submenu = button.nextElementSibling;
    submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
  }

  function openSearchModal() {
    const searchModal = document.getElementById('search-modal');
    searchModal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeSearchModal() {
    const searchModal = document.getElementById('search-modal');
    searchModal.classList.remove('active');
    document.body.style.overflow = '';
  }

  async function openCartDrawer() {
    const cartDrawer = document.getElementById('cart-drawer');
    cartDrawer.classList.add('active');
    document.body.style.overflow = 'hidden';
    await loadCartDrawer();
  }

  function closeCartDrawer() {
    const cartDrawer = document.getElementById('cart-drawer');
    cartDrawer.classList.remove('active');
    document.body.style.overflow = '';
  }

  async function loadCartDrawer() {
    const content = document.getElementById('cart-content');
    const recommended = document.getElementById('recommended-products').querySelector('.cart-drawer__recommended-grid');
    
    try {
      const response = await fetch('/cart.js');
      const cartData = await response.json();
      
      if (cartData.items.length === 0) {
        content.innerHTML = '<div class="cart-drawer__empty"><p>Your cart is empty.</p></div>';
        recommended.innerHTML = '';
        updateCartCount();
        return;
      }
      
      let html = '';
      cartData.items.forEach(item => {
        html += `
          <div class="cart-drawer__item">
            <img src="${item.image}?width=100" alt="${item.title}">
            <div>
              <h3>${item.title}</h3>
              <p>${formatMoney(item.price)}</p>
              <input type="number" value="${item.quantity}" min="0" onchange="updateCartItem('${item.key}', this.value)">
              <button onclick="updateCartItem('${item.key}', 0)">Remove</button>
            </div>
          </div>
        `;
      });
      content.innerHTML = html;
      updateCartCount();
      await loadRecommendedProducts();
    } catch (error) {
      content.innerHTML = '<div class="cart-drawer__empty"><p>Error loading cart.</p></div>';
    }
  }

  async function updateCartItem(key, quantity) {
    try {
      await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates: { [key]: quantity } })
      });
      await loadCartDrawer();
    } catch (error) {
      console.error('Error updating cart:', error);
    }
  }

  async function loadRecommendedProducts() {
    const recommended = document.getElementById('recommended-products').querySelector('.cart-drawer__recommended-grid');
    try {
      const response = await fetch('/collections/{{ recommended_collection }}/products.json?limit=4');
      const data = await response.json();
      let html = '';
      data.products.forEach(product => {
        const price = formatMoney(product.variants[0].price * 100);
        html += `
          <div class="cart-drawer__recommended-item">
            <img src="${product.images[0]}?width=200" alt="${product.title}">
            <h4>${product.title}</h4>
            <p>${price}</p>
            <button onclick="addToCart('${product.variants[0].id}')">Add to Cart</button>
          </div>
        `;
      });
      recommended.innerHTML = html;
    } catch (error) {
      recommended.innerHTML = '<p>Unable to load recommendations.</p>';
    }
  }

  async function addToCart(variantId) {
    try {
      const formData = new FormData();
      formData.append('id', variantId);
      formData.append('quantity', 1);
      await fetch('/cart/add.js', { method: 'POST', body: formData });
      await loadCartDrawer();
    } catch (error) {
      console.error('Error adding to cart:', error);
    }
  }

  function updateCartCount() {
    const bubble = document.getElementById('cart-icon-bubble').querySelector('.cart-count-bubble');
    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        bubble.textContent = cart.item_count;
        bubble.style.display = cart.item_count > 0 ? 'flex' : 'none';
      });
  }

  function formatMoney(cents) {
    return (cents / 100).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
  }

  document.querySelectorAll('.header__nav-item').forEach(item => {
    item.addEventListener('mouseenter', () => {
      const megaMenu = item.querySelector('.mega-menu');
      if (megaMenu) megaMenu.classList.add('active');
    });
    item.addEventListener('mouseleave', () => {
      const megaMenu = item.querySelector('.mega-menu');
      if (megaMenu) megaMenu.classList.remove('active');
    });
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeSearchModal();
      closeCartDrawer();
      closeCompareModal();
    }
  });

  // ============ WISHLIST & COMPARE FUNCTIONALITY ============
  let wishlistItems = JSON.parse(localStorage.getItem('shopify_wishlist') || '[]');
  let compareItems = [];
  let relatedProducts = [];

  document.addEventListener('DOMContentLoaded', function() {
    updateWishlistCount();
    updateCompareCount();
  });

  function toggleWishlist() {
    alert('Wishlist functionality - You can implement a full wishlist page here');
    const heart = document.querySelector('.wishlist-heart');
    heart.classList.toggle('active');
  }

  function updateWishlistCount() {
    const wishlistBubble = document.getElementById('wishlist-count');
    if (wishlistBubble) {
      if (wishlistItems.length > 0) {
        wishlistBubble.textContent = wishlistItems.length;
        wishlistBubble.style.display = 'flex';
      } else {
        wishlistBubble.style.display = 'none';
      }
    }
  }

  function updateCompareCount() {
    const compareBubble = document.getElementById('compare-count');
    if (compareBubble) {
      if (compareItems.length > 0) {
        compareBubble.textContent = compareItems.length;
        compareBubble.style.display = 'flex';
      } else {
        compareBubble.style.display = 'none';
      }
    }
  }

  async function openCompareModal() {
    const modal = document.getElementById('compare-modal');
    if (modal) {
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      await loadRelatedProductsForCompare();
    }
  }

  function closeCompareModal() {
    const modal = document.getElementById('compare-modal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  async function loadRelatedProductsForCompare() {
    const gridContainer = document.getElementById('compare-products-grid');
    if (!gridContainer) return;
    
    gridContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Loading products...</p>';
    
    try {
      const cartResponse = await fetch('/cart.js');
      const cartData = await cartResponse.json();
      
      if (!cartData.items || cartData.items.length === 0) {
        gridContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Your cart is empty. Add items to cart first to compare related products.</p>';
        return;
      }
      
      const cartProductInfo = cartData.items.map(item => ({
        title: item.product_title,
        handle: item.handle,
        id: item.product_id
      }));
      
      relatedProducts = [];
      
      for (const cartItem of cartProductInfo.slice(0, 3)) {
        try {
          const productResponse = await fetch(`/products/${cartItem.handle}.js`);
          if (productResponse.ok) {
            const productData = await productResponse.json();
            if (productData.collections && productData.collections.length > 0) {
              const collectionHandle = productData.collections[0].handle;
              const collectionResponse = await fetch(`/collections/${collectionHandle}/products.json?limit=10`);
              if (collectionResponse.ok) {
                const collectionData = await collectionResponse.json();
                if (collectionData.products) {
                  relatedProducts.push(...collectionData.products);
                }
              }
            }
          }
        } catch (error) {
          console.log('Error fetching related products for:', cartItem.handle);
        }
      }
      
      if (relatedProducts.length < 10) {
        try {
          const allProductsResponse = await fetch('/collections/all/products.json?limit=20');
          if (allProductsResponse.ok) {
            const allProductsData = await allProductsResponse.json();
            if (allProductsData.products) {
              relatedProducts.push(...allProductsData.products);
            }
          }
        } catch (error) {
          console.log('Error fetching fallback products');
        }
      }
      
      const cartProductIds = cartData.items.map(item => item.product_id);
      const uniqueProducts = relatedProducts.filter((product, index, self) => 
        index === self.findIndex(p => p.id === product.id) && 
        !cartProductIds.includes(product.id)
      ).slice(0, 12);
      
      if (uniqueProducts.length > 0) {
        renderCompareProducts(uniqueProducts, gridContainer);
      } else {
        gridContainer.innerHTML = '<p style="text-align: center; padding: 20px;">No related products found.</p>';
      }
    } catch (error) {
      console.error('Error loading products for comparison:', error);
      gridContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">Error loading products. Please try again.</p>';
    }
  }

  function renderCompareProducts(products, container) {
    let html = '';
    products.forEach(product => {
      const price = formatMoney(product.variants[0].price * 100);
      const imageUrl = product.images[0] ? product.images[0] + '?width=160' : '';
      const isSelected = compareItems.some(item => item.id === product.id);
      html += `
        <div class="compare-product-card ${isSelected ? 'selected' : ''}" 
             data-product-id="${product.id}"
             onclick="toggleCompareProduct(${product.id})">
          <img src="${imageUrl}" 
               alt="${product.title}" 
               class="compare-product-image"
               onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCA4MCA4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNDAgMjBjMTEuMDQ2IDAgMjAgOC45NTQgMjAgMjBzLTguOTU0IDIwLTIwIDIwLTIwLTguOTU0LTIwLTIwIDguOTU0LTIwIDIwLTIwWm0tNy4wNzEgNy4wNzFhMTQgMTQgMCAwIDAgMCAxOS43OThhMTQgMTQgMCAwIDAgMTkuNzk4IDBMNDM5IDM5bC05LjE5Mi05LjE5MloiIGZpbGw9IiNlNWU1ZTUiLz48L3N2Zz4='">
          <div class="compare-product-name">${product.title}</div>
          <div class="compare-product-price">${price}</div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  function toggleCompareProduct(productId) {
    const product = relatedProducts.find(p => p.id === productId);
    if (!product) return;
    const existingIndex = compareItems.findIndex(item => item.id === productId);
    if (existingIndex > -1) {
      compareItems.splice(existingIndex, 1);
    } else {
      if (compareItems.length >= 2) {
        alert('You can compare maximum 2 products at a time');
        return;
      }
      compareItems.push(product);
    }
    updateCompareUI();
    updateCompareCount();
  }

  function updateCompareUI() {
    document.querySelectorAll('.compare-product-card').forEach(card => {
      const productId = parseInt(card.dataset.productId);
      if (compareItems.some(item => item.id === productId)) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    });
    const emptyState = document.getElementById('compare-empty-state');
    const compareTable = document.getElementById('compare-table');
    const compareActions = document.getElementById('compare-actions');
    if (compareItems.length === 2) {
      if (emptyState) emptyState.style.display = 'none';
      if (compareTable) {
        compareTable.style.display = 'grid';
        renderComparisonTable();
      }
      if (compareActions) compareActions.style.display = 'flex';
    } else {
      if (emptyState) emptyState.style.display = 'block';
      if (compareTable) compareTable.style.display = 'none';
      if (compareActions) compareActions.style.display = 'none';
    }
  }

  function renderComparisonTable() {
    const compareTable = document.getElementById('compare-table');
    if (!compareTable || compareItems.length !== 2) return;
    const [product1, product2] = compareItems;
    const details1 = extractProductDetails(product1);
    const details2 = extractProductDetails(product2);
    let html = `
      <div class="compare-table-header">
        <div class="compare-header-label">FEATURE</div>
        <div class="compare-header-product">
          <button class="compare-remove-btn" onclick="removeFromComparison(${product1.id})">×</button>
          <img src="${details1.image}" alt="${product1.title}" class="compare-product-main-image">
          <div class="compare-product-title">${product1.title}</div>
          <div class="compare-product-main-price">${details1.price}</div>
        </div>
        <div class="compare-header-product">
          <button class="compare-remove-btn" onclick="removeFromComparison(${product2.id})">×</button>
          <img src="${details2.image}" alt="${product2.title}" class="compare-product-main-image">
          <div class="compare-product-title">${product2.title}</div>
          <div class="compare-product-main-price">${details2.price}</div>
        </div>
      </div>
      <div class="compare-table-row">
        <div class="compare-row-label">Price</div>
        <div class="compare-row-value ${details1.rawPrice < details2.rawPrice ? 'better' : ''}">${details1.price}</div>
        <div class="compare-row-value ${details2.rawPrice < details1.rawPrice ? 'better' : ''}">${details2.price}</div>
      </div>
      <div class="compare-table-row">
        <div class="compare-row-label">Availability</div>
        <div class="compare-row-value">${details1.availability}</div>
        <div class="compare-row-value">${details2.availability}</div>
      </div>
      <div class="compare-table-row">
        <div class="compare-row-label">SKU</div>
        <div class="compare-row-value">${details1.sku}</div>
        <div class="compare-row-value">${details2.sku}</div>
      </div>
      <div class="compare-table-row">
        <div class="compare-row-label">Vendor</div>
        <div class="compare-row-value">${details1.vendor}</div>
        <div class="compare-row-value">${details2.vendor}</div>
      </div>
      <div class="compare-table-row">
        <div class="compare-row-label">Type</div>
        <div class="compare-row-value">${details1.type}</div>
        <div class="compare-row-value">${details2.type}</div>
      </div>
      <div class="compare-table-row">
        <div class="compare-row-label">Tags</div>
        <div class="compare-row-value">${details1.tags}</div>
        <div class="compare-row-value">${details2.tags}</div>
      </div>
      <div class="compare-table-row">
        <div class="compare-row-label">Options</div>
        <div class="compare-row-value">${details1.options}</div>
        <div class="compare-row-value">${details2.options}</div>
      </div>
    `;
    compareTable.innerHTML = html;
  }

  function extractProductDetails(product) {
    const variant = product.variants[0];
    return {
      image: product.images[0] ? product.images[0] + '?width=300' : '',
      price: formatMoney(variant.price * 100),
      rawPrice: variant.price,
      availability: variant.available ? 'In Stock' : 'Out of Stock',
      sku: variant.sku || 'N/A',
      vendor: product.vendor || 'N/A',
      type: product.product_type || 'N/A',
      tags: product.tags.length > 0 ? product.tags.slice(0, 3).join(', ') : 'N/A',
      options: product.options.map(opt => opt.name).join(', ') || 'N/A'
    };
  }

  function removeFromComparison(productId) {
    compareItems = compareItems.filter(item => item.id !== productId);
    updateCompareUI();
    updateCompareCount();
  }

  function clearComparison() {
    compareItems = [];
    updateCompareUI();
    updateCompareCount();
  }

  async function addComparedToCart() {
    if (compareItems.length !== 2) return;
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Adding...';
    button.disabled = true;
    try {
      for (const product of compareItems) {
        const formData = new FormData();
        formData.append('id', product.variants[0].id);
        formData.append('quantity', 1);
        await fetch('/cart/add.js', { method: 'POST', body: formData });
      }
      await loadCartDrawer();
      updateCartCount();
      button.textContent = 'Added to Cart!';
      button.style.background = '#4CAF50';
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '';
        button.disabled = false;
        clearComparison();
        closeCompareModal();
        openCartDrawer();
      }, 2000);
    } catch (error) {
      console.error('Error adding products to cart:', error);
      button.textContent = 'Error - Try Again';
      button.style.background = '#e74c3c';
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '';
        button.disabled = false;
      }, 2000);
    }
  }
</script>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Image"
    },
    {
      "type": "range",
      "id": "logo_height_desktop",
      "label": "Logo Height (Desktop)",
      "min": 20,
      "max": 200,
      "step": 10,
      "default": 50
    },
    {
      "type": "range",
      "id": "logo_height_mobile",
      "label": "Logo Height (Mobile)",
      "min": 20,
      "max": 150,
      "step": 10,
      "default": 40
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Main Menu",
      "default": "main-menu"
    },
    {
      "type": "checkbox",
      "id": "show_mega_menu",
      "label": "Show Mega Menu",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "sticky_header",
      "label": "Sticky Header",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "transparent_header",
      "label": "Transparent Header",
      "default": false
    },
    {
      "type": "color",
      "id": "header_bg_color",
      "label": "Header Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "nav_color",
      "label": "Navigation Text Color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "nav_hover_color",
      "label": "Navigation Hover Color",
      "default": "#667eea"
    },
    {
      "type": "text",
      "id": "recommended_collection",
      "label": "Recommended Products Collection Handle",
      "default": "recommended"
    }
  ]
}
{% endschema %}